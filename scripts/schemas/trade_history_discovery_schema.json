{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://sensylate.com/schemas/trade_history_discovery.json",
  "title": "Trade History Discovery Schema",
  "description": "JSON Schema for validating trade history discovery phase outputs with institutional-grade quality standards and algorithmic trading validation",
  "type": "object",
  "anyOf": [
    {
      "required": [
        "portfolio",
        "discovery_metadata",
        "portfolio_summary",
        "strategy_distribution",
        "ticker_performance",
        "performance_metrics",
        "active_positions",
        "data_quality_assessment",
        "local_data_integration",
        "next_phase_inputs"
      ]
    },
    {
      "required": [
        "metadata",
        "portfolio_summary",
        "strategy_distribution",
        "ticker_performance",
        "performance_metrics",
        "active_positions",
        "data_quality",
        "market_data_collection"
      ]
    },
    {
      "required": [
        "portfolio",
        "discovery_metadata",
        "authoritative_trade_data",
        "market_context",
        "data_quality_assessment",
        "next_phase_inputs"
      ]
    }
  ],
  "additionalProperties": true,
  "properties": {
    "portfolio": {
      "type": "string",
      "description": "Portfolio identifier for trade history analysis",
      "const": "live_signals"
    },
    "discovery_metadata": {
      "type": "object",
      "description": "Execution metadata and framework validation context",
      "required": ["execution_timestamp", "confidence_score", "data_completeness"],
      "additionalProperties": true,
      "properties": {
        "execution_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp with microsecond precision"
        },
        "protocol_version": {
          "type": "string",
          "enum": ["DASV_Phase_1_Comprehensive", "DASV_1.0"]
        },
        "data_source": {
          "type": "string",
          "description": "Authoritative data source path"
        },
        "confidence_score": {
          "type": "number",
          "minimum": 0.7,
          "maximum": 1.0,
          "description": "Overall discovery confidence score (institutional threshold: >0.7)"
        },
        "data_completeness": {
          "type": "number",
          "anyOf": [
            {
              "minimum": 0.6,
              "maximum": 1.0,
              "description": "Data completeness as decimal (0.6-1.0)"
            },
            {
              "minimum": 60.0,
              "maximum": 100.0,
              "description": "Data completeness as percentage (60-100%)"
            }
          ]
        },
        "derivable_fields_calculated": {
          "type": "number",
          "minimum": 0.9,
          "maximum": 1.0,
          "description": "Algorithmic field derivation success rate"
        },
        "collection_duration": {
          "type": "string",
          "pattern": "^\\d+s$"
        },
        "data_sources_used": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["csv", "yahoo_finance", "fred_economic", "coingecko", "fundamental_analysis", "sector_analysis", "alpha_vantage"]
          },
          "minItems": 1
        },
        "cache_hit_ratio": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "memory_optimization_achieved": {
          "type": "string"
        }
      }
    },
    "portfolio_summary": {
      "type": "object",
      "description": "High-level portfolio statistics and trade universe",
      "required": ["total_trades", "closed_trades", "active_trades", "unique_tickers"],
      "additionalProperties": true,
      "properties": {
        "total_trades": {
          "type": "integer",
          "minimum": 10,
          "description": "Statistical adequacy threshold: minimum 10 trades"
        },
        "closed_trades": {
          "type": "integer",
          "minimum": 5,
          "description": "Minimum closed trades for performance analysis"
        },
        "active_trades": {
          "type": "integer",
          "minimum": 0,
          "maximum": 50,
          "description": "Current active position count"
        },
        "unique_tickers": {
          "type": "integer",
          "minimum": 5,
          "description": "Diversification requirement: minimum 5 unique tickers"
        },
        "date_range": {
          "type": "object",
          "properties": {
            "earliest_entry": {
              "type": "string",
              "format": "date"
            },
            "latest_entry": {
              "type": "string",
              "format": "date"
            }
          }
        }
      }
    },
    "strategy_distribution": {
      "type": "object",
      "description": "Trading strategy allocation and validation",
      "required": ["EMA", "SMA"],
      "additionalProperties": false,
      "properties": {
        "EMA": {
          "type": "integer",
          "minimum": 0,
          "description": "Exponential Moving Average strategy count"
        },
        "SMA": {
          "type": "integer",
          "minimum": 0,
          "description": "Simple Moving Average strategy count"
        }
      }
    },
    "ticker_performance": {
      "type": "object",
      "description": "Individual ticker performance tracking with statistical validation",
      "patternProperties": {
        "^[A-Z]{1,5}$": {
          "type": "object",
          "required": ["total_trades", "total_return", "win_rate"],
          "additionalProperties": true,
          "properties": {
            "total_trades": {
              "type": "integer",
              "minimum": 1
            },
            "closed_trades": {
              "type": "integer",
              "minimum": 0
            },
            "active_trades": {
              "type": "integer",
              "minimum": 0
            },
            "total_return": {
              "type": "number",
              "description": "Cumulative return for ticker"
            },
            "win_rate": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0,
              "description": "Win rate as decimal (0.0 to 1.0)"
            },
            "wins": {
              "type": "integer",
              "minimum": 0
            },
            "losses": {
              "type": "integer",
              "minimum": 0
            },
            "avg_return": {
              "type": "number"
            }
          }
        }
      },
      "additionalProperties": false,
      "minProperties": 5
    },
    "performance_metrics": {
      "type": "object",
      "description": "Institutional-grade performance metrics and risk-adjusted returns",
      "anyOf": [
        {
          "required": ["total_closed_trades", "win_rate", "total_wins", "total_losses", "profit_factor"]
        },
        {
          "required": ["win_rate", "total_wins", "total_losses", "profit_factor"]
        }
      ],
      "additionalProperties": true,
      "properties": {
        "total_closed_trades": {
          "type": "integer",
          "minimum": 5,
          "description": "Minimum trades for statistical significance"
        },
        "win_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Overall win rate (institutional benchmark: >0.45)"
        },
        "total_wins": {
          "type": "integer",
          "minimum": 1
        },
        "total_losses": {
          "type": "integer",
          "minimum": 0
        },
        "total_breakeven": {
          "type": "integer",
          "minimum": 0
        },
        "average_win_return": {
          "type": "number",
          "minimum": 0.01,
          "description": "Average winning trade return (minimum 1%)"
        },
        "average_loss_return": {
          "type": "number",
          "maximum": -0.005,
          "description": "Average losing trade return (risk management threshold)"
        },
        "profit_factor": {
          "type": "number",
          "minimum": 1.0,
          "description": "Profit factor (institutional threshold: >1.0)"
        },
        "total_pnl": {
          "type": "number",
          "description": "Total profit and loss in base currency"
        },
        "total_return_percentage": {
          "type": "number",
          "description": "Total return as percentage"
        }
      }
    },
    "active_positions": {
      "type": "array",
      "description": "Real-time active position monitoring with risk assessment",
      "items": {
        "type": "object",
        "required": ["ticker", "strategy", "days_held"],
        "additionalProperties": true,
        "properties": {
          "ticker": {
            "type": "string",
            "pattern": "^[A-Z]{1,5}$"
          },
          "strategy": {
            "type": "string",
            "enum": ["EMA", "SMA"]
          },
          "days_held": {
            "type": "number",
            "minimum": 0,
            "maximum": 365,
            "description": "Position age in days (risk monitoring threshold)"
          },
          "current_return": {
            "type": "number",
            "description": "Unrealized return for active position"
          },
          "entry_date": {
            "type": "string",
            "format": "date"
          },
          "position_uuid": {
            "type": "string",
            "description": "Unique position identifier for tracking"
          }
        }
      },
      "maxItems": 50
    },
    "data_quality_assessment": {
      "type": "object",
      "description": "Comprehensive data quality validation with institutional standards",
      "anyOf": [
        {
          "required": ["overall_confidence"],
          "properties": {
            "overall_confidence": {
              "type": "number",
              "minimum": 0.75,
              "maximum": 1.0,
              "description": "Overall data confidence (institutional threshold: >0.75)"
            },
            "trade_data_completeness": {
              "type": "number",
              "minimum": 0.7,
              "maximum": 1.0,
              "description": "Trade data completeness ratio"
            },
            "validation_confidence": {
              "type": "number",
              "minimum": 0.95,
              "maximum": 1.0,
              "description": "Validation process confidence"
            }
          }
        },
        {
          "required": ["overall_confidence"],
          "properties": {
            "overall_confidence": {
              "type": "number",
              "minimum": 0.75,
              "maximum": 1.0
            },
            "completeness_score": {
              "type": "number",
              "minimum": 0.7,
              "maximum": 1.0
            },
            "freshness_score": {
              "type": "number",
              "minimum": 0.7,
              "maximum": 1.0
            },
            "source_reliability": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.0
            },
            "cross_validation_score": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.0
            }
          }
        }
      ],
      "additionalProperties": true,
      "properties": {
        "derivable_fields_confidence": {
          "type": "number",
          "minimum": 0.9,
          "maximum": 1.0,
          "description": "Algorithmic field derivation confidence"
        },
        "fundamental_coverage_confidence": {
          "type": "number",
          "minimum": 0.3,
          "maximum": 1.0,
          "description": "Fundamental analysis coverage confidence"
        },
        "validation_issues_count": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5,
          "description": "Number of validation issues (acceptable threshold: ≤5)"
        },
        "validation_issues": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "maxItems": 5
        },
        "quality_issues": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "improvement_recommendations": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "data_quality": {
      "type": "object",
      "description": "Alternative data quality structure for compatibility",
      "properties": {
        "trades_with_complete_data": {
          "type": "integer",
          "minimum": 1
        },
        "trades_missing_exit_data": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5
        },
        "trades_missing_return_data": {
          "type": "integer",
          "minimum": 0,
          "maximum": 0
        }
      }
    },
    "local_data_integration": {
      "type": "object",
      "description": "Local data source integration and coverage assessment",
      "anyOf": [
        {
          "required": ["execution_timestamp", "total_tickers", "coverage_statistics"]
        },
        {
          "required": ["total_tickers"]
        }
      ],
      "additionalProperties": true,
      "properties": {
        "execution_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "total_tickers": {
          "type": "integer",
          "minimum": 5
        },
        "fundamental_analysis_coverage": {
          "type": "object",
          "patternProperties": {
            "^[A-Z]{1,5}$": {
              "type": "object",
              "required": ["file_path", "file_date", "age_days"],
              "properties": {
                "file_path": {
                  "type": "string"
                },
                "file_date": {
                  "type": "string",
                  "format": "date-time"
                },
                "age_days": {
                  "type": "integer",
                  "minimum": 0,
                  "maximum": 90,
                  "description": "Analysis age in days (freshness threshold: ≤90)"
                }
              }
            }
          }
        },
        "tickers_with_local_data": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]{1,5}$"
          },
          "minItems": 1
        },
        "coverage_statistics": {
          "type": "object",
          "required": ["fundamental_analysis_coverage", "tickers_with_analysis", "tickers_missing_analysis"],
          "properties": {
            "fundamental_analysis_coverage": {
              "type": "number",
              "minimum": 0.25,
              "maximum": 1.0,
              "description": "Fundamental analysis coverage ratio (minimum 25%)"
            },
            "tickers_with_analysis": {
              "type": "integer",
              "minimum": 1
            },
            "tickers_missing_analysis": {
              "type": "integer",
              "minimum": 0
            },
            "coverage_percentage": {
              "type": "number",
              "minimum": 25.0,
              "maximum": 100.0
            }
          }
        }
      }
    },
    "market_data_collection": {
      "type": "object",
      "description": "Market data collection statistics and validation (alternative structure)",
      "properties": {
        "total_tickers": {
          "type": "integer",
          "minimum": 1
        },
        "local_data_used": {
          "type": "integer",
          "minimum": 0
        },
        "external_calls_made": {
          "type": "integer",
          "minimum": 0
        },
        "failed_lookups": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "next_phase_inputs": {
      "type": "object",
      "description": "Analysis readiness validation and transition criteria",
      "anyOf": [
        {
          "required": ["analysis_ready", "required_confidence_met", "closed_trades_count", "active_trades_count"]
        },
        {
          "required": ["analysis_ready", "required_confidence_met"]
        }
      ],
      "additionalProperties": true,
      "properties": {
        "analysis_ready": {
          "type": "boolean",
          "const": true,
          "description": "Analysis phase readiness confirmation"
        },
        "required_confidence_met": {
          "type": "boolean",
          "description": "Confidence threshold validation"
        },
        "closed_trades_count": {
          "type": "integer",
          "minimum": 5,
          "description": "Statistical adequacy: minimum 5 closed trades"
        },
        "active_trades_count": {
          "type": "integer",
          "minimum": 0,
          "maximum": 50
        },
        "statistical_adequacy": {
          "type": "boolean",
          "description": "Statistical adequacy validation"
        },
        "data_package_complete": {
          "type": "boolean",
          "description": "Data package completeness validation"
        },
        "data_package_path": {
          "type": "string",
          "description": "Path to complete data package"
        },
        "analysis_focus_areas": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["signal_effectiveness", "strategy_performance_comparison", "market_context_correlation", "fundamental_alignment_analysis", "risk_adjusted_performance", "active_position_monitoring"]
          },
          "minItems": 1
        },
        "recommended_next_steps": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Alternative metadata structure for compatibility",
      "properties": {
        "portfolio": {
          "type": "string"
        },
        "discovery_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "data_source": {
          "type": "string"
        },
        "protocol_version": {
          "type": "string"
        },
        "phase": {
          "type": "string"
        }
      }
    },
    "phase0_inventory": {
      "type": "object",
      "description": "Phase 0 inventory assessment for discovery framework",
      "properties": {
        "local_data_coverage": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "tickers_with_local_data": {
          "type": "integer",
          "minimum": 0
        },
        "total_unique_tickers": {
          "type": "integer",
          "minimum": 1
        },
        "fundamental_analysis_files": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "authoritative_trade_data": {
      "type": "object",
      "description": "Comprehensive trade data validation and quality assessment",
      "properties": {
        "csv_file_path": {
          "type": "string"
        },
        "comprehensive_trade_summary": {
          "type": "object",
          "properties": {
            "total_trades": {
              "type": "integer",
              "minimum": 1
            },
            "closed_positions": {
              "type": "integer",
              "minimum": 0
            },
            "active_positions": {
              "type": "integer",
              "minimum": 0
            },
            "data_completeness": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.0
            },
            "categorization_accuracy": {
              "type": "number",
              "minimum": 0.95,
              "maximum": 1.0
            }
          }
        }
      }
    },
    "market_context": {
      "type": "object",
      "description": "Market environment context for trade analysis",
      "properties": {
        "benchmark_data": {
          "type": "object",
          "patternProperties": {
            "^(SPY|QQQ|VTI)$": {
              "type": "object",
              "properties": {
                "current_price": {
                  "type": "number",
                  "minimum": 0
                },
                "market_cap": {
                  "type": "number",
                  "minimum": 0
                },
                "pe_ratio": {
                  "type": "number",
                  "minimum": 0
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0.8,
                  "maximum": 1.0
                }
              }
            }
          }
        },
        "volatility_environment": {
          "type": "object",
          "properties": {
            "VIXY_current": {
              "type": "number",
              "minimum": 10,
              "maximum": 200
            },
            "market_regime": {
              "type": "string",
              "enum": ["low_volatility", "moderate_volatility", "high_volatility", "extreme_volatility"]
            },
            "confidence": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.0
            }
          }
        },
        "economic_context": {
          "type": "object",
          "properties": {
            "fed_funds_rate": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 10.0
            },
            "rate_environment": {
              "type": "string",
              "enum": ["accommodative", "neutral", "restrictive"]
            },
            "confidence": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.0
            }
          }
        },
        "crypto_context": {
          "type": "object",
          "properties": {
            "bitcoin_price": {
              "type": "number",
              "minimum": 1000
            },
            "market_sentiment": {
              "type": "string",
              "enum": ["very_negative", "negative", "neutral", "positive", "very_positive"]
            },
            "confidence": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.0
            }
          }
        }
      }
    },
    "fundamental_integration": {
      "type": "object",
      "description": "Fundamental analysis integration and alignment assessment",
      "properties": {
        "analysis_coverage": {
          "type": "object",
          "properties": {
            "tickers_with_analysis": {
              "type": "integer",
              "minimum": 0
            },
            "total_tickers": {
              "type": "integer",
              "minimum": 1
            },
            "coverage_percentage": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 100.0
            },
            "confidence": {
              "type": "number",
              "minimum": 0.7,
              "maximum": 1.0
            }
          }
        }
      }
    },
    "cli_service_validation": {
      "type": "object",
      "description": "CLI service health monitoring and validation",
      "properties": {
        "service_health": {
          "type": "string",
          "enum": ["operational", "degraded", "offline"]
        },
        "health_score": {
          "type": "number",
          "minimum": 0.8,
          "maximum": 1.0
        },
        "services_operational": {
          "type": "integer",
          "minimum": 3,
          "maximum": 7
        },
        "services_healthy": {
          "type": "boolean",
          "const": true
        },
        "cli_services_utilized": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["yahoo_finance", "fred_economic", "coingecko", "alpha_vantage", "fmp_cli"]
          },
          "minItems": 3,
          "maxItems": 7
        }
      }
    },
    "cli_data_quality": {
      "type": "object",
      "description": "CLI data quality assessment with institutional standards",
      "properties": {
        "overall_data_quality": {
          "type": "number",
          "minimum": 0.85,
          "maximum": 1.0
        },
        "cli_service_health": {
          "type": "number",
          "minimum": 0.8,
          "maximum": 1.0
        },
        "institutional_grade": {
          "type": "boolean",
          "const": true
        },
        "data_sources_via_cli": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["yahoo_finance", "fred_economic", "coingecko", "alpha_vantage"]
          },
          "minItems": 3,
          "maxItems": 7
        },
        "cli_integration_status": {
          "type": "string",
          "const": "operational"
        }
      }
    },
    "cli_insights": {
      "type": "object",
      "description": "CLI integration insights and observational data",
      "properties": {
        "cli_integration_observations": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 3
        },
        "data_quality_insights": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 3
        },
        "market_context_insights": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 3
        }
      }
    },
    "sector_analysis": {
      "type": "object",
      "description": "Sector analysis integration and context",
      "properties": {
        "available_sectors": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 10
        },
        "sector_coverage": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "sector_context_quality": {
          "type": "object",
          "properties": {
            "coverage_percentage": {
              "type": "number",
              "minimum": 80.0,
              "maximum": 100.0
            },
            "confidence": {
              "type": "number",
              "minimum": 0.8,
              "maximum": 1.0
            }
          }
        }
      }
    },
    "local_data_optimization": {
      "type": "object",
      "description": "Local data optimization and API efficiency metrics",
      "properties": {
        "local_data_coverage": {
          "type": "object",
          "properties": {
            "fundamental_analysis": {
              "type": "string",
              "pattern": "^\\d+\\.\\d+%$"
            },
            "sector_analysis": {
              "type": "string",
              "pattern": "^\\d+%$"
            },
            "cache_utilization": {
              "type": "string",
              "pattern": "^\\d+%$"
            }
          }
        },
        "api_call_reduction": {
          "type": "object",
          "properties": {
            "reduction_percentage": {
              "type": "number",
              "minimum": 50.0,
              "maximum": 95.0,
              "description": "API call reduction (efficiency target: >50%)"
            }
          }
        }
      }
    },
    "market_data_collection": {
      "type": "object",
      "description": "Market data collection statistics and validation",
      "properties": {
        "total_tickers": {
          "type": "integer",
          "minimum": 1
        },
        "local_data_used": {
          "type": "integer",
          "minimum": 0
        },
        "external_calls_made": {
          "type": "integer",
          "minimum": 0
        },
        "failed_lookups": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "data_quality": {
      "type": "object",
      "description": "Data quality validation metrics",
      "properties": {
        "trades_with_complete_data": {
          "type": "integer",
          "minimum": 1
        },
        "trades_missing_exit_data": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5
        },
        "trades_missing_return_data": {
          "type": "integer",
          "minimum": 0,
          "maximum": 0
        }
      }
    }
  }
}
