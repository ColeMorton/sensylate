{% extends "shared/base_analysis_template.j2" %}

{# Enhanced Fundamental Analysis Template using shared inheritance and macros #}
{# Reduces template duplication by 40-50% through shared components #}

{% block title %}{{ data.company_name | default(ticker) }} ({{ ticker }}) - Fundamental Analysis{% endblock %}

{% block description %}Institutional-quality fundamental analysis of {{ ticker }} with economic context, stress testing, and multi-source validation{% endblock %}

{% block primary_tag %}fundamental-analysis{% endblock %}

{% block header %}{{ data.company_name | default(ticker) }} ({{ ticker }}) - Fundamental Analysis{% endblock %}

{% block author_note %}(MANDATORY - ensure consistency){% endblock %}

{% block investment_thesis %}
### Core Thesis
{{ data.investment_thesis | default("Core investment thesis with key value drivers based on comprehensive analysis.") }}

### Recommendation: {{ data.recommendation | default("HOLD") }} | Conviction: {{ data.conviction | default("0.80") }}/1.0
- **Fair Value Range**: ${{ data.fair_value_low | default("N/A") }} - ${{ data.fair_value_high | default("N/A") }} (Current: ${{ data.current_price | default("N/A") }}) | Confidence: {{ data.valuation_confidence | default("0.85") }}/1.0
- **Expected Return**: {{ data.expected_return | default("N/A") }}% ({{ data.time_horizon | default("12") }}M horizon) | Economic-Adjusted: {{ data.economic_adjusted_return | default("N/A") }}%
- **Risk-Adjusted Return**: {{ data.risk_adjusted_return | default("N/A") }}% (Sharpe: {{ data.sharpe_ratio | default("N/A") }}) | Interest Rate Impact: {{ data.interest_rate_impact | default("N/A") }}%
- **Position Size**: {{ data.position_size | default("N/A") }}% of portfolio | Economic Environment: {{ data.economic_environment | default("Neutral") }}
- **Financial Health Grade**: {{ data.financial_health_grade | default("B") }} Overall | Trend: {{ data.financial_health_trend | default("Stable") }}
{% endblock %}

{% block investment_details %}
### Key Quantified Catalysts (Next 12-24 Months)
{%- if data.catalysts %}
{%- for catalyst in data.catalysts[:3] %}
{{ loop.index }}. {{ catalyst.name }} - Probability: {{ catalyst.probability | default("0.50") }} | Impact: ${{ catalyst.impact_per_share | default("N/A") }}/share | Timeline: {{ catalyst.timeline | default("12") }}mo | Economic Sensitivity: {{ catalyst.economic_sensitivity | default("Medium") }}
{%- endfor %}
{%- else %}
1. {{ data.catalyst_1 | default("Primary catalyst") }} - Probability: {{ data.catalyst_1_probability | default("0.50") }} | Impact: ${{ data.catalyst_1_impact | default("N/A") }}/share | Timeline: {{ data.catalyst_1_timeline | default("12") }}mo | Economic Sensitivity: {{ data.catalyst_1_sensitivity | default("Medium") }}
2. {{ data.catalyst_2 | default("Secondary catalyst") }} - Probability: {{ data.catalyst_2_probability | default("0.40") }} | Impact: ${{ data.catalyst_2_impact | default("N/A") }}/share | Timeline: {{ data.catalyst_2_timeline | default("18") }}mo | Economic Sensitivity: {{ data.catalyst_2_sensitivity | default("Medium") }}
3. {{ data.catalyst_3 | default("Third catalyst") }} - Probability: {{ data.catalyst_3_probability | default("0.30") }} | Impact: ${{ data.catalyst_3_impact | default("N/A") }}/share | Timeline: {{ data.catalyst_3_timeline | default("24") }}mo | Economic Sensitivity: {{ data.catalyst_3_sensitivity | default("Low") }}
{%- endif %}

{% from 'shared/macros/economic_sensitivity_macro.j2' import economic_context_impact %}
{{ economic_context_impact(data) }}
{% endblock %}

{% block analysis_specific_content %}
## 📊 Business Intelligence Dashboard

### Business-Specific KPIs
| Metric | Current | 3Y Avg | 5Y Trend | vs Peers | Confidence | Insight |
|--------|---------|---------|-----------|----------|------------|---------|
{%- if data.business_kpis %}
{%- for kpi in data.business_kpis %}
| {{ kpi.name }} | {{ kpi.current | default("N/A") }} | {{ kpi.three_year_avg | default("N/A") }} | {{ kpi.five_year_trend | default("N/A") }} | {{ kpi.vs_peers | default("N/A") }} | {{ kpi.confidence | default("0.80") }} | {{ kpi.insight | default("N/A") }} |
{%- endfor %}
{%- else %}
| {{ data.kpi_1_name | default("Revenue Growth") }} | {{ data.kpi_1_current | default("N/A") }} | {{ data.kpi_1_3y_avg | default("N/A") }} | {{ data.kpi_1_5y_trend | default("N/A") }} | {{ data.kpi_1_vs_peers | default("N/A") }} | {{ data.kpi_1_confidence | default("0.80") }} | {{ data.kpi_1_insight | default("N/A") }} |
| {{ data.kpi_2_name | default("Margin Expansion") }} | {{ data.kpi_2_current | default("N/A") }} | {{ data.kpi_2_3y_avg | default("N/A") }} | {{ data.kpi_2_5y_trend | default("N/A") }} | {{ data.kpi_2_vs_peers | default("N/A") }} | {{ data.kpi_2_confidence | default("0.80") }} | {{ data.kpi_2_insight | default("N/A") }} |
{%- endif %}

### Financial Health Scorecard
| Category | Score | Trend | Key Metrics | Red Flags |
|----------|-------|-------|-------------|-----------|
| Profitability | {{ data.profitability_grade | default("B") }} | {{ data.profitability_trend | default("→") }} | {{ data.profitability_metrics | default("ROE, Margins") }} | {{ data.profitability_red_flags | default("None") }} |
| Balance Sheet | {{ data.balance_sheet_grade | default("B") }} | {{ data.balance_sheet_trend | default("→") }} | {{ data.balance_sheet_metrics | default("Debt/Equity, Liquidity") }} | {{ data.balance_sheet_red_flags | default("None") }} |
| Cash Flow | {{ data.cash_flow_grade | default("B") }} | {{ data.cash_flow_trend | default("→") }} | {{ data.cash_flow_metrics | default("FCF, OCF") }} | {{ data.cash_flow_red_flags | default("None") }} |
| Capital Efficiency | {{ data.capital_efficiency_grade | default("B") }} | {{ data.capital_efficiency_trend | default("→") }} | {{ data.capital_efficiency_metrics | default("ROIC, Asset Turnover") }} | {{ data.capital_efficiency_red_flags | default("None") }} |

## 📊 Cross-Sector Positioning Dashboard

### Cross-Sector Relative Analysis

#### Valuation Metrics Comparison
| Metric | Current | vs SPY | vs Sector | vs Top 3 Correlated | Confidence |
|--------|---------|--------|-----------|---------------------|------------|
| P/E Ratio | {{ data.pe_ratio | default("25.5") }} | {{ data.pe_vs_spy | default("+15") }}% | {{ data.pe_vs_sector | default("+5") }}% | {{ data.pe_vs_correlated_1 | default("Tech: +10%") }}, {{ data.pe_vs_correlated_2 | default("Healthcare: -5%") }}, {{ data.pe_vs_correlated_3 | default("Industrials: +8%") }} | {{ data.pe_confidence | default("0.92") }} |
| P/B Ratio | {{ data.pb_ratio | default("3.2") }} | {{ data.pb_vs_spy | default("+20") }}% | {{ data.pb_vs_sector | default("+8") }}% | {{ data.pb_vs_correlated_1 | default("Tech: +15%") }}, {{ data.pb_vs_correlated_2 | default("Healthcare: +2%") }}, {{ data.pb_vs_correlated_3 | default("Industrials: +12%") }} | {{ data.pb_confidence | default("0.90") }} |
| EV/EBITDA | {{ data.ev_ebitda | default("18.5") }} | {{ data.ev_vs_spy | default("+10") }}% | {{ data.ev_vs_sector | default("+3") }}% | {{ data.ev_vs_correlated_1 | default("Tech: +8%") }}, {{ data.ev_vs_correlated_2 | default("Healthcare: -2%") }}, {{ data.ev_vs_correlated_3 | default("Industrials: +5%") }} | {{ data.ev_confidence | default("0.88") }} |
| Dividend Yield | {{ data.dividend_yield | default("1.8") }}% | {{ data.div_vs_spy | default("-50") }}bps | {{ data.div_vs_sector | default("-20") }}bps | {{ data.div_vs_correlated_1 | default("Tech: -30bps") }}, {{ data.div_vs_correlated_2 | default("Healthcare: +80bps") }}, {{ data.div_vs_correlated_3 | default("Industrials: +40bps") }} | {{ data.div_confidence | default("0.95") }} |

#### Sector Relative Positioning
- **Primary Sector**: {{ data.primary_sector | default("Technology") }} | **Industry**: {{ data.industry_classification | default("Software & Services") }}
- **Sector Ranking**: {{ data.sector_ranking | default("Top") }} Quartile | **Performance Scores**: ROE {{ data.roe_percentile | default("85") }}th percentile, Margin {{ data.margin_percentile | default("78") }}th percentile
- **Relative Strengths**: {{ data.sector_strengths | default("Innovation capacity, recurring revenue models, pricing power") }}
- **Improvement Areas**: {{ data.sector_weaknesses | default("Regulatory exposure, competition intensity") }}

### Sector Rotation Assessment
- **Sector Rotation Score**: {{ data.rotation_score | default("7.5") }}/10 | **Current Market Environment**: {{ data.market_environment | default("Favorable") }}
- **Cycle Preference**: Typically performs best in {{ data.cycle_preference | default("Early to Mid") }} cycle phases
- **Interest Rate Sensitivity**: {{ data.rate_sensitivity | default("Moderate Negative") }} | Current environment: {{ data.rate_environment_impact | default("Headwind") }}
- **Economic Sensitivity**: {{ data.economic_sensitivity | default("Moderate") }} with {{ data.gdp_correlation | default("±0.30") }} GDP correlation
- **Rotation Outlook**: {{ data.rotation_outlook | default("Moderately favored") }} for sector rotation
- **Tactical Considerations**: {{ data.tactical_considerations | default("Economic cycle timing, interest rate trajectory, sector momentum indicators") }}

## 🧪 Economic Stress Testing

### Stress Test Scenarios
| Scenario | Probability | Stock Impact | SPY Impact | Recovery Timeline | Confidence |
|----------|-------------|--------------|------------|-------------------|------------|
| GDP Contraction (-2%) | {{ data.gdp_contraction_probability | default("0.20") }} | {{ data.gdp_contraction_impact | default("-25") }}% ({{ data.gdp_elasticity | default("1.2") }}x elasticity) | {{ data.gdp_contraction_spy_impact | default("-15 to -20") }}% | {{ data.gdp_recovery_timeline | default("2-3") }} quarters | {{ data.gdp_stress_confidence | default("0.80") }} |
| Employment Shock (-500k) | {{ data.employment_shock_probability | default("0.15") }} | {{ data.employment_shock_impact | default("-20") }}% ({{ data.employment_sensitivity | default("1.0") }}x sensitivity) | Labor-sensitive impact | {{ data.employment_recovery_timeline | default("2-4") }} quarters | {{ data.employment_stress_confidence | default("0.75") }} |
| Bear Market (-20%) | {{ data.bear_market_probability | default("0.25") }} | {{ data.bear_market_impact | default("-25 to -30") }}% | Baseline | {{ data.bear_recovery_timeline | default("2-3") }} quarters | {{ data.bear_stress_confidence | default("0.85") }} |
| Interest Rate Shock (+200bp) | {{ data.rate_shock_probability | default("0.10") }} | {{ data.rate_shock_impact | default("-15") }}% duration impact | Market-wide effects | {{ data.rate_recovery_timeline | default("3-4") }} quarters | {{ data.rate_stress_confidence | default("0.80") }} |
| Recession | {{ data.recession_probability_detailed | default("0.25") }} | {{ data.recession_impact | default("-30") }}% historical | Recovery context | {{ data.recession_recovery_timeline | default("18-24") }} months | {{ data.recession_stress_confidence | default("0.75") }} |

### Stress Test Summary
- **Worst Case Impact**: {{ data.worst_case_impact | default("-30") }}% in {{ data.worst_case_scenario | default("Recession") }} | **Average Impact**: {{ data.average_impact | default("-23") }}% across scenarios
- **Probability-Weighted Impact**: {{ data.probability_weighted_impact | default("-8.5") }}% expected downside | **Recovery Timeline**: {{ data.average_recovery | default("2.8") }} quarters average
- **Key Vulnerabilities**: {{ data.key_vulnerabilities | default("GDP sensitivity, employment correlation, interest rate duration") }}
- **Stress Test Score**: {{ data.stress_test_score | default("75") }}/100 (100 baseline, adjusted for economic sensitivity)
- **Risk Assessment**: {{ data.risk_assessment | default("Moderate") }} Risk - {{ data.risk_assessment_summary | default("Standard cyclical sensitivity with average recovery profile") }}

### Portfolio Implications from Stress Testing
- **Position Sizing Guidance**: {{ data.position_sizing_guidance | default("Conservative") }} sizing recommended ({{ data.max_position_size | default("3-5") }}% max position)
- **Risk Category**: {{ data.risk_category | default("Moderate vulnerability") }} during economic stress
- **Hedging Strategies**: {{ data.hedging_strategies | default("Interest rate hedging, sector diversification, defensive positioning during late cycle") }}
- **Recovery Outlook**: Average recovery {{ data.average_recovery | default("2.8") }} quarters with {{ data.recovery_factors | default("economic normalization and sector rotation") }}

{% from 'shared/macros/economic_sensitivity_macro.j2' import liquidity_cycle_positioning %}
{{ liquidity_cycle_positioning(data, "fundamental") }}

## 🏆 Competitive Position Analysis

### Moat Assessment
| Competitive Advantage | Strength | Durability | Evidence | Confidence |
|----------------------|----------|------------|----------|------------|
{%- if data.moat_advantages %}
{%- for advantage in data.moat_advantages %}
| {{ advantage.name }} | {{ advantage.strength | default("6") }}/10 | {{ advantage.durability | default("5") }}/10 | {{ advantage.evidence | default("Supporting evidence") }} | {{ advantage.confidence | default("0.80") }} |
{%- endfor %}
{%- else %}
| {{ data.moat_1_name | default("Primary Advantage") }} | {{ data.moat_1_strength | default("6") }}/10 | {{ data.moat_1_durability | default("5") }}/10 | {{ data.moat_1_evidence | default("Supporting evidence") }} | {{ data.moat_1_confidence | default("0.80") }} |
| {{ data.moat_2_name | default("Secondary Advantage") }} | {{ data.moat_2_strength | default("5") }}/10 | {{ data.moat_2_durability | default("4") }}/10 | {{ data.moat_2_evidence | default("Supporting evidence") }} | {{ data.moat_2_confidence | default("0.75") }} |
{%- endif %}

### Industry Dynamics
- **Market Growth**: {{ data.market_growth | default("5") }}% CAGR | TAM: ${{ data.tam | default("100") }}B
- **Competitive Intensity**: {{ data.competitive_intensity | default("Medium") }} | HHI: {{ data.hhi_index | default("1500") }}
- **Disruption Risk**: {{ data.disruption_risk | default("Medium") }} | Key Threats: {{ data.key_threats | default("Technology, regulation") }}
- **Regulatory Outlook**: {{ data.regulatory_outlook | default("Neutral") }}
{% endblock %}

{% block valuation_section %}
## 📈 Valuation Analysis

{% from 'shared/macros/valuation_framework_macro.j2' import multi_method_valuation, scenario_analysis %}
{{ multi_method_valuation(data.valuation_methods if data.valuation_methods else [], "fundamental") }}

{{ scenario_analysis(data, "fundamental") }}
{% endblock %}

{% block risk_assessment %}
{# Use the shared risk assessment macro with fundamental-specific context #}
{% from 'shared/macros/risk_assessment_macro.j2' import risk_matrix, economic_risk_assessment, sensitivity_analysis %}
{{ risk_matrix(data.risk_factors if data.risk_factors else [], "fundamental") }}

{{ economic_risk_assessment(data, "fundamental") }}

{{ sensitivity_analysis(data, "fundamental") }}
{% endblock %}

{% block investment_summary %}
{{ data.company_name | default(ticker) }} ({{ ticker }}) represents a {{ data.investment_characterization | default("compelling") }} investment opportunity with {{ data.risk_return_potential | default("strong") }} risk-adjusted return potential, supported by {{ data.fundamental_health | default("excellent") }} fundamental health and positioned {{ data.cycle_positioning | default("favorably") }} within the current economic cycle. The investment demonstrates {{ data.economic_sensitivity | default("moderate") }} economic sensitivity with {{ data.gdp_correlation | default("±0.30") }} GDP correlation and {{ data.employment_correlation | default("±0.25") }} employment sensitivity, positioning it as a {{ data.cycle_phase | default("mid") }}-cycle outperformer during {{ data.expansion_performance | default("economic expansion") }} phases. Cross-sector relative analysis reveals {{ data.valuation_advantages | default("reasonable valuation") }} advantages, with P/E trading at {{ data.pe_vs_spy | default("+15") }}% premium to SPY while {{ data.relative_strength | default("demonstrating significant outperformance") }} across {{ data.performance_periods | default("multiple time periods") }}. Financial health assessment grades the company {{ data.financial_health_grade | default("B") }} overall, with {{ data.strength_areas | default("profitability and balance sheet strength") }} providing {{ data.downside_protection | default("downside protection") }} and {{ data.risk_factors_summary | default("moderate cyclical exposure and competitive risks") }} warranting {{ data.risk_management | default("active monitoring") }}.

Key catalysts include {{ data.catalyst_1 | default("operational improvements") }} with {{ data.catalyst_1_probability | default("0.50") }} probability and ${{ data.catalyst_1_impact | default("15") }}/share impact, {{ data.catalyst_2 | default("market expansion") }} with {{ data.catalyst_2_probability | default("0.40") }} probability and ${{ data.catalyst_2_impact | default("12") }}/share impact, and {{ data.catalyst_3 | default("efficiency gains") }} with {{ data.catalyst_3_probability | default("0.30") }} probability and ${{ data.catalyst_3_impact | default("8") }}/share impact, while primary risks encompass {{ data.gdp_risk_probability | default("0.30") }} probability GDP deceleration risk ({{ data.gdp_risk_impact | default("4") }}/5 impact) and {{ data.competitive_risk_probability | default("0.40") }} probability competitive pressure ({{ data.competitive_risk_impact | default("3") }}/5 impact). Valuation analysis through DCF/Comps/Technical methods yields ${{ data.fair_value_low | default("180") }}-${{ data.fair_value_high | default("220") }} fair value range with {{ data.overall_valuation_confidence | default("0.80") }} confidence, representing {{ data.expected_return | default("15") }}% expected returns over {{ data.time_horizon | default("12") }}-month horizon. Current {{ data.fed_policy_stance | default("restrictive") }} monetary policy environment with {{ data.fed_funds_rate | default("5.25") }}% Fed funds rate and {{ data.yield_curve_status | default("normal") }} yield curve {{ data.economic_environment_impact | default("creates moderate headwinds") }} for near-term performance, while {{ data.gdp_growth | default("2.5") }}% GDP growth and {{ data.employment_growth | default("150") }}k employment trends {{ data.economic_alignment | default("align favorably") }} with the company's economic sensitivity profile. Portfolio allocation guidance recommends {{ data.position_size | default("4-6") }}% position sizing for {{ data.portfolio_type | default("balanced") }} portfolios, with {{ data.positioning_recommendation | default("neutral") }} positioning relative to {{ data.benchmark_weight | default("market") }} benchmark allocation based on {{ data.risk_adjusted_expectations | default("moderate risk-adjusted return expectations") }}, {{ data.cycle_timing | default("mid-cycle economic timing") }}, and {{ data.opportunity_set | default("cross-sector opportunity assessment") }}.
{% endblock %}
