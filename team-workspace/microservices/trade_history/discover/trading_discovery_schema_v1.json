{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Trading Discovery Output Schema",
  "description": "Schema for trade_history_discover microservice output",
  "type": "object",
  "required": [
    "portfolio",
    "discovery_metadata",
    "authoritative_trade_data",
    "market_context",
    "data_quality_assessment",
    "next_phase_inputs"
  ],
  "properties": {
    "portfolio": {
      "type": "string",
      "description": "Portfolio name being analyzed"
    },
    "discovery_metadata": {
      "type": "object",
      "required": ["execution_timestamp", "confidence_score", "data_completeness"],
      "properties": {
        "execution_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "confidence_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "data_completeness": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "collection_duration": {
          "type": "string"
        },
        "data_sources_used": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "cache_hit_ratio": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    },
    "authoritative_trade_data": {
      "type": "object",
      "required": ["csv_file_path", "total_trades", "data_confidence"],
      "properties": {
        "csv_file_path": {
          "type": "string"
        },
        "total_trades": {
          "type": "integer",
          "minimum": 0
        },
        "open_positions": {
          "type": "integer",
          "minimum": 0
        },
        "closed_positions": {
          "type": "integer",
          "minimum": 0
        },
        "date_range": {
          "type": "object",
          "properties": {
            "earliest_entry": {
              "type": "string",
              "format": "date"
            },
            "latest_entry": {
              "type": "string",
              "format": "date"
            },
            "latest_exit": {
              "type": "string",
              "format": "date"
            }
          }
        },
        "position_sizing_methodology": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["fixed", "calculated"]
            },
            "value": {
              "type": "number"
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "strategy_distribution": {
          "type": "object",
          "patternProperties": {
            "^(SMA|EMA)$": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "ticker_universe": {
          "type": "object",
          "properties": {
            "total_tickers": {
              "type": "integer",
              "minimum": 0
            },
            "unique_tickers": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "sector_distribution": {
              "type": "object",
              "patternProperties": {
                ".*": {
                  "type": "integer",
                  "minimum": 0
                }
              }
            }
          }
        },
        "data_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    },
    "market_context": {
      "type": "object",
      "properties": {
        "benchmark_data": {
          "type": "object",
          "patternProperties": {
            "^[A-Z]{2,5}$": {
              "type": "object",
              "properties": {
                "current_price": {
                  "type": "number"
                },
                "ytd_return": {
                  "type": "number"
                },
                "volatility": {
                  "type": "number"
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                }
              }
            }
          }
        },
        "volatility_environment": {
          "type": "object",
          "properties": {
            "VIX_current": {
              "type": "number"
            },
            "VIX_average": {
              "type": "number"
            },
            "market_regime": {
              "type": "string"
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "economic_context": {
          "type": "object",
          "properties": {
            "fed_funds_rate": {
              "type": "number"
            },
            "rate_environment": {
              "type": "string"
            },
            "major_events": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "date": {
                    "type": "string",
                    "format": "date"
                  },
                  "event": {
                    "type": "string"
                  },
                  "impact": {
                    "type": "string"
                  }
                }
              }
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        }
      }
    },
    "fundamental_integration": {
      "type": "object",
      "properties": {
        "analysis_coverage": {
          "type": "object",
          "properties": {
            "tickers_with_analysis": {
              "type": "integer",
              "minimum": 0
            },
            "total_tickers": {
              "type": "integer",
              "minimum": 0
            },
            "coverage_percentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "analysis_files": {
          "type": "object",
          "patternProperties": {
            "^[A-Z]{1,5}$": {
              "type": "object",
              "properties": {
                "file": {
                  "type": "string"
                },
                "recommendation": {
                  "type": "string",
                  "enum": ["BUY", "HOLD", "SELL"]
                },
                "price_target": {
                  "type": "number"
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                }
              }
            }
          }
        }
      }
    },
    "research_enhancement": {
      "type": "object",
      "properties": {
        "economic_calendar": {
          "type": "object",
          "properties": {
            "key_events_identified": {
              "type": "integer",
              "minimum": 0
            },
            "market_moving_events": {
              "type": "integer",
              "minimum": 0
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "sector_analysis": {
          "type": "object",
          "properties": {
            "primary_sectors": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "sector_performance": {
              "type": "object",
              "patternProperties": {
                ".*": {
                  "type": "string"
                }
              }
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "market_sentiment": {
          "type": "object",
          "properties": {
            "overall_sentiment": {
              "type": "string"
            },
            "key_themes": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        }
      }
    },
    "data_quality_assessment": {
      "type": "object",
      "required": ["overall_confidence"],
      "properties": {
        "overall_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "completeness_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "freshness_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "source_reliability": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "cross_validation_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "quality_issues": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "improvement_recommendations": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "next_phase_inputs": {
      "type": "object",
      "required": ["analysis_ready", "data_package_path"],
      "properties": {
        "analysis_ready": {
          "type": "boolean"
        },
        "required_confidence_met": {
          "type": "boolean"
        },
        "data_package_path": {
          "type": "string"
        },
        "analysis_focus_areas": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
