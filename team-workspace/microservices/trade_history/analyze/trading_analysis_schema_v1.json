{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Trading Analysis Output Schema",
  "description": "Schema for trade_history_analyze microservice output",
  "type": "object",
  "required": [
    "portfolio",
    "analysis_metadata",
    "signal_effectiveness",
    "performance_measurement",
    "pattern_recognition",
    "optimization_opportunities",
    "risk_assessment",
    "statistical_validation",
    "analysis_quality_assessment",
    "next_phase_inputs"
  ],
  "properties": {
    "portfolio": {
      "type": "string",
      "description": "Portfolio name being analyzed"
    },
    "analysis_metadata": {
      "type": "object",
      "required": ["execution_timestamp", "confidence_score", "analysis_completeness"],
      "properties": {
        "execution_timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "confidence_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "analysis_completeness": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "calculation_duration": {
          "type": "string"
        },
        "statistical_significance": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "sample_size_adequacy": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    },
    "signal_effectiveness": {
      "type": "object",
      "required": ["entry_signal_analysis", "exit_signal_analysis"],
      "properties": {
        "entry_signal_analysis": {
          "type": "object",
          "properties": {
            "win_rate_by_strategy": {
              "type": "object",
              "patternProperties": {
                "^(SMA|EMA)$": {
                  "type": "object",
                  "properties": {
                    "win_rate": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    },
                    "total_trades": {
                      "type": "integer",
                      "minimum": 0
                    },
                    "winners": {
                      "type": "integer",
                      "minimum": 0
                    },
                    "losers": {
                      "type": "integer",
                      "minimum": 0
                    },
                    "average_return_winners": {
                      "type": "number"
                    },
                    "average_return_losers": {
                      "type": "number"
                    },
                    "confidence": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    }
                  }
                }
              }
            },
            "signal_timing_effectiveness": {
              "type": "object",
              "properties": {
                "avg_days_to_mfe": {
                  "type": "number"
                },
                "entry_timing_efficiency": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                },
                "market_condition_correlation": {
                  "type": "number",
                  "minimum": -1,
                  "maximum": 1
                },
                "optimal_entry_differential": {
                  "type": "number"
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                }
              }
            }
          }
        },
        "exit_signal_analysis": {
          "type": "object",
          "properties": {
            "exit_efficiency_metrics": {
              "type": "object",
              "properties": {
                "overall_exit_efficiency": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                },
                "mfe_capture_rate": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                },
                "avg_hold_period": {
                  "type": "number"
                },
                "optimal_hold_period": {
                  "type": "number"
                },
                "exit_timing_differential": {
                  "type": "number"
                },
                "confidence": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1
                }
              }
            },
            "exit_timing_quality": {
              "type": "object",
              "properties": {
                "hold_period_optimization": {
                  "type": "object",
                  "properties": {
                    "short_term_le_7d": {
                      "type": "object",
                      "properties": {
                        "count": {"type": "integer", "minimum": 0},
                        "avg_return": {"type": "number"},
                        "efficiency": {"type": "number", "minimum": 0, "maximum": 1}
                      }
                    },
                    "medium_term_8_30d": {
                      "type": "object",
                      "properties": {
                        "count": {"type": "integer", "minimum": 0},
                        "avg_return": {"type": "number"},
                        "efficiency": {"type": "number", "minimum": 0, "maximum": 1}
                      }
                    },
                    "long_term_gt_30d": {
                      "type": "object",
                      "properties": {
                        "count": {"type": "integer", "minimum": 0},
                        "avg_return": {"type": "number"},
                        "efficiency": {"type": "number", "minimum": 0, "maximum": 1}
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "performance_measurement": {
      "type": "object",
      "required": ["statistical_analysis", "trade_quality_classification"],
      "properties": {
        "statistical_analysis": {
          "type": "object",
          "properties": {
            "return_distribution": {
              "type": "object",
              "properties": {
                "mean_return": {"type": "number"},
                "median_return": {"type": "number"},
                "std_deviation": {"type": "number", "minimum": 0},
                "skewness": {"type": "number"},
                "kurtosis": {"type": "number"},
                "normality_test_p_value": {"type": "number", "minimum": 0, "maximum": 1},
                "confidence": {"type": "number", "minimum": 0, "maximum": 1}
              }
            },
            "risk_adjusted_metrics": {
              "type": "object",
              "properties": {
                "sharpe_ratio": {"type": "number"},
                "sortino_ratio": {"type": "number"},
                "calmar_ratio": {"type": "number"},
                "max_drawdown": {"type": "number", "maximum": 0},
                "confidence": {"type": "number", "minimum": 0, "maximum": 1}
              }
            },
            "benchmark_comparison": {
              "type": "object",
              "properties": {
                "alpha_vs_SPY": {"type": "number"},
                "beta_vs_SPY": {"type": "number"},
                "tracking_error": {"type": "number", "minimum": 0},
                "information_ratio": {"type": "number"},
                "outperformance_probability": {"type": "number", "minimum": 0, "maximum": 1},
                "confidence": {"type": "number", "minimum": 0, "maximum": 1}
              }
            }
          }
        },
        "trade_quality_classification": {
          "type": "object",
          "properties": {
            "excellent_trades": {
              "type": "object",
              "properties": {
                "count": {"type": "integer", "minimum": 0},
                "percentage": {"type": "number", "minimum": 0, "maximum": 1},
                "avg_return": {"type": "number"},
                "characteristics": {
                  "type": "array",
                  "items": {"type": "string"}
                }
              }
            },
            "good_trades": {
              "type": "object",
              "properties": {
                "count": {"type": "integer", "minimum": 0},
                "percentage": {"type": "number", "minimum": 0, "maximum": 1},
                "avg_return": {"type": "number"},
                "characteristics": {
                  "type": "array",
                  "items": {"type": "string"}
                }
              }
            },
            "poor_trades": {
              "type": "object",
              "properties": {
                "count": {"type": "integer", "minimum": 0},
                "percentage": {"type": "number", "minimum": 0, "maximum": 1},
                "avg_return": {"type": "number"},
                "characteristics": {
                  "type": "array",
                  "items": {"type": "string"}
                }
              }
            },
            "failed_trades": {
              "type": "object",
              "properties": {
                "count": {"type": "integer", "minimum": 0},
                "percentage": {"type": "number", "minimum": 0, "maximum": 1},
                "avg_return": {"type": "number"},
                "characteristics": {
                  "type": "array",
                  "items": {"type": "string"}
                }
              }
            }
          }
        }
      }
    },
    "pattern_recognition": {
      "type": "object",
      "properties": {
        "signal_temporal_patterns": {
          "type": "object",
          "properties": {
            "monthly_effectiveness": {
              "type": "object",
              "patternProperties": {
                "^(january|february|march|april|may|june|july|august|september|october|november|december)$": {
                  "type": "object",
                  "properties": {
                    "win_rate": {"type": "number", "minimum": 0, "maximum": 1},
                    "avg_return": {"type": "number"}
                  }
                }
              }
            },
            "market_regime_performance": {
              "type": "object",
              "properties": {
                "bull_market": {
                  "type": "object",
                  "properties": {
                    "win_rate": {"type": "number", "minimum": 0, "maximum": 1},
                    "avg_return": {"type": "number"},
                    "trade_count": {"type": "integer", "minimum": 0}
                  }
                },
                "bear_market": {
                  "type": "object",
                  "properties": {
                    "win_rate": {"type": "number", "minimum": 0, "maximum": 1},
                    "avg_return": {"type": "number"},
                    "trade_count": {"type": "integer", "minimum": 0}
                  }
                },
                "sideways_market": {
                  "type": "object",
                  "properties": {
                    "win_rate": {"type": "number", "minimum": 0, "maximum": 1},
                    "avg_return": {"type": "number"},
                    "trade_count": {"type": "integer", "minimum": 0}
                  }
                }
              }
            },
            "volatility_environment": {
              "type": "object",
              "properties": {
                "low_vix_lt_15": {
                  "type": "object",
                  "properties": {
                    "win_rate": {"type": "number", "minimum": 0, "maximum": 1},
                    "avg_return": {"type": "number"},
                    "trade_count": {"type": "integer", "minimum": 0}
                  }
                },
                "medium_vix_15_25": {
                  "type": "object",
                  "properties": {
                    "win_rate": {"type": "number", "minimum": 0, "maximum": 1},
                    "avg_return": {"type": "number"},
                    "trade_count": {"type": "integer", "minimum": 0}
                  }
                },
                "high_vix_gt_25": {
                  "type": "object",
                  "properties": {
                    "win_rate": {"type": "number", "minimum": 0, "maximum": 1},
                    "avg_return": {"type": "number"},
                    "trade_count": {"type": "integer", "minimum": 0}
                  }
                }
              }
            }
          }
        }
      }
    },
    "optimization_opportunities": {
      "type": "object",
      "properties": {
        "entry_signal_enhancements": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "opportunity": {"type": "string"},
              "potential_improvement": {"type": "string"},
              "implementation": {"type": "string"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        },
        "exit_signal_refinements": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "opportunity": {"type": "string"},
              "potential_improvement": {"type": "string"},
              "implementation": {"type": "string"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        },
        "strategy_parameter_optimization": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "parameter": {"type": "string"},
              "current": {"type": "string"},
              "optimized": {"type": "string"},
              "improvement_potential": {"type": "string"},
              "market_regime": {"type": "string"},
              "confidence": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        }
      }
    },
    "risk_assessment": {
      "type": "object",
      "properties": {
        "portfolio_risk_metrics": {
          "type": "object",
          "properties": {
            "position_correlation": {
              "type": "object",
              "properties": {
                "avg_correlation": {"type": "number", "minimum": -1, "maximum": 1},
                "max_correlation": {"type": "number", "minimum": -1, "maximum": 1},
                "sector_concentration": {
                  "type": "object",
                  "patternProperties": {
                    ".*": {"type": "number", "minimum": 0, "maximum": 1}
                  }
                },
                "diversification_ratio": {"type": "number", "minimum": 0, "maximum": 1},
                "confidence": {"type": "number", "minimum": 0, "maximum": 1}
              }
            },
            "drawdown_analysis": {
              "type": "object",
              "properties": {
                "max_drawdown": {"type": "number", "maximum": 0},
                "avg_drawdown": {"type": "number", "maximum": 0},
                "drawdown_duration": {"type": "number", "minimum": 0},
                "recovery_time": {"type": "number", "minimum": 0},
                "downside_deviation": {"type": "number", "minimum": 0},
                "confidence": {"type": "number", "minimum": 0, "maximum": 1}
              }
            }
          }
        },
        "market_context_risk": {
          "type": "object",
          "properties": {
            "market_beta": {"type": "number"},
            "market_correlation": {"type": "number", "minimum": -1, "maximum": 1},
            "regime_sensitivity": {
              "type": "object",
              "properties": {
                "bull_outperformance": {"type": "number"},
                "bear_underperformance": {"type": "number"},
                "sideways_neutral": {"type": "number"}
              }
            },
            "volatility_sensitivity": {
              "type": "object",
              "properties": {
                "vix_correlation": {"type": "number", "minimum": -1, "maximum": 1},
                "volatility_beta": {"type": "number"}
              }
            },
            "confidence": {"type": "number", "minimum": 0, "maximum": 1}
          }
        }
      }
    },
    "statistical_validation": {
      "type": "object",
      "required": ["sample_size_assessment"],
      "properties": {
        "sample_size_assessment": {
          "type": "object",
          "properties": {
            "total_trades": {"type": "integer", "minimum": 0},
            "closed_trades": {"type": "integer", "minimum": 0},
            "minimum_required": {"type": "integer", "minimum": 0},
            "adequacy_score": {"type": "number", "minimum": 0, "maximum": 1},
            "power_analysis": {"type": "number", "minimum": 0, "maximum": 1}
          }
        },
        "significance_testing": {
          "type": "object",
          "properties": {
            "return_vs_zero": {
              "type": "object",
              "properties": {
                "t_statistic": {"type": "number"},
                "p_value": {"type": "number", "minimum": 0, "maximum": 1},
                "significant": {"type": "boolean"}
              }
            },
            "alpha_vs_benchmark": {
              "type": "object",
              "properties": {
                "t_statistic": {"type": "number"},
                "p_value": {"type": "number", "minimum": 0, "maximum": 1},
                "significant": {"type": "boolean"}
              }
            },
            "win_rate_vs_random": {
              "type": "object",
              "properties": {
                "z_statistic": {"type": "number"},
                "p_value": {"type": "number", "minimum": 0, "maximum": 1},
                "significant": {"type": "boolean"}
              }
            }
          }
        },
        "confidence_intervals": {
          "type": "object",
          "properties": {
            "mean_return": {
              "type": "object",
              "properties": {
                "lower": {"type": "number"},
                "upper": {"type": "number"},
                "confidence_level": {"type": "number", "minimum": 0, "maximum": 1}
              }
            },
            "sharpe_ratio": {
              "type": "object",
              "properties": {
                "lower": {"type": "number"},
                "upper": {"type": "number"},
                "confidence_level": {"type": "number", "minimum": 0, "maximum": 1}
              }
            },
            "win_rate": {
              "type": "object",
              "properties": {
                "lower": {"type": "number", "minimum": 0, "maximum": 1},
                "upper": {"type": "number", "minimum": 0, "maximum": 1},
                "confidence_level": {"type": "number", "minimum": 0, "maximum": 1}
              }
            }
          }
        }
      }
    },
    "analysis_quality_assessment": {
      "type": "object",
      "required": ["overall_confidence"],
      "properties": {
        "overall_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "calculation_accuracy": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "statistical_robustness": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "pattern_reliability": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "optimization_feasibility": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "quality_issues": {
          "type": "array",
          "items": {"type": "string"}
        },
        "improvement_recommendations": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "next_phase_inputs": {
      "type": "object",
      "required": ["synthesis_ready", "analysis_package_path"],
      "properties": {
        "synthesis_ready": {"type": "boolean"},
        "confidence_threshold_met": {"type": "boolean"},
        "analysis_package_path": {"type": "string"},
        "report_focus_areas": {
          "type": "array",
          "items": {"type": "string"}
        },
        "critical_findings": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    }
  }
}
